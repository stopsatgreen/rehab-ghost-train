<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello, World! • A-Frame</title>
    <meta name="description" content="Hello, World! • A-Frame">
    <script src="https://aframe.io/releases/0.2.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene stats>

      <a-assets>
        <img src="creepy.jpg" id="creepy">
        <img src="ghost.png" id="ghost">
        <img src="spider.png" id="spider">
      </a-assets>

      <a-box src="#creepy" side="back" height="4" width="4" depth="8"></a-box>

      <a-plane src="#ghost" side="double" id="phantom" opacity="0.7" position="0 -1 3" scale="2 2 2" transparent="true">
        <a-animation attribute="position" begin="ghost-attack" from="0 -1 3" to="0 -1 0"></a-animation>
        <a-animation attribute="opacity" begin="ghost-attack" duration="1500" from="0.7" to="0"></a-animation>
      </a-plane>

      <a-plane src="#spider" id="arachnid" side="double" position="0 0 -1" transparent="true">
        <a-animation id="spider-attack-start" attribute="position" begin="spider-attack" from="0 0 -1" to="0 -1 -1"></a-animation>
        <a-animation attribute="position" begin="spider-retreat" from="0 -1 -1" to="0 0 -1"></a-animation>
      </a-plane>

      <a-plane id="start" color="red" position="0 -1 -1" height="0.5" width="0.5"></a-plane>

      <a-entity position="0 -1 0">
        <a-camera>
          <a-cursor fuse></a-cursor>
        </a-camera>
      </a-entity>

    </a-scene>

    <script>
    var scene = document.querySelector('a-scene');
    if (scene.hasLoaded) {
      run();
    } else {
      scene.addEventListener('loaded', run);
    }
    window.requestTimeout = function(fn, delay) {
      var start = new Date().getTime();
      var handle = new Object();
		  function loop(){
		    var current = new Date().getTime();
        var delta = current - start;
			  delta >= delay ? fn.call() : handle.value = requestAnimationFrame(loop);
      };
      handle.value = requestAnimationFrame(loop);
	    return handle;
    };
    function run() {

      var spider = document.querySelector('#arachnid');

      document.querySelector('#start').addEventListener('click', event => {
        event.currentTarget.setAttribute('visible', false);
        requestTimeout(() => {
          spider.emit('spider-attack');
        }, 5000);
      });

      document.querySelector('#spider-attack-start').addEventListener('animationend', () => {
        requestTimeout(() => {
          spider.emit('spider-retreat');
        }, 2000);
      });

      document.querySelector('#phantom').addEventListener('click', event => {
        event.currentTarget.emit('ghost-attack');
      });
    }
    </script>

  </body>
</html>
